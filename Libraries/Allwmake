#! /bin/sh

BISONPATH=`which bison`
NOBISON=$?

if [[ $NOBISON != 0 ]]; then
    echo "No 'bison' found. This is absolutely essential for swak4Foam. Can't go on"
    exit 42
fi

FLEXPATH=`which flex`
NOFLEX=$?

if [[ $NOFLEX != 0 ]]; then
    echo "No 'flex' found. This is absolutely essential for swak4Foam. Can't go on"
    exit 42
fi

BISONVER=`bison -V | head -n 1| tr ' ' '\n' | tail -n 1`

echo "Bison is version $BISONVER"

if [[ $BISONVER < 2.3 ]]; then 
    echo "swak4Foam only confirmed to work with Bison >= 2.3"
    if [ -z $USE_OLD_BISON ]; then 
	echo "Set the environment variable USE_OLD_BISON if you want to continue anyway"
	exit 42
    else
	echo "I continue under protest. Should swak4Foam work with your bison-version, then please report it"
	echo
	echo
    fi
fi

of_version_major=`echo $WM_PROJECT_VERSION | sed -e 's=\([0-9]*\).*=\1='`
of_version_minor=`echo $WM_PROJECT_VERSION | sed -e 's=[0-9]*\.\([0-9]*\).*=\1='`
of_version_patch=`echo $WM_PROJECT_VERSION | sed -e 's=[0-9]*\.[0-9]*\.\([0-9a-z]*\).*=\1='`
echo "OpenFOAM-version: Major $of_version_major Minor $of_version_minor Patch $of_version_patch"

versionFile=swak4FoamParsers/foamVersion4swak.H

cat >$versionFile.tmp <<EOF
// generated by the Allwmake-script of the swak4Foam-distro
#ifndef foamVersion4swak_H
#define foamVersion4swak_H

#define FOAM_VERSION4SWAK_MAJOR $of_version_major
#define FOAM_VERSION4SWAK_MINOR $of_version_minor
#define FOAM_VERSION4SWAK_PATCH $of_version_patch

#endif
EOF

if [ -e $versionFile ]; then
    nrDiff=`diff $versionFile.tmp $versionFile | wc -l | tr -d " "`
    if [[ $nrDiff > 0 ]]; then
	echo "$versionFile changed"
	mv $versionFile.tmp $versionFile
    else
	# Make sure that not a complete recompilation is triggered
	echo "No change to $versionFile"
	rm $versionFile.tmp
    fi
else
    echo "No $versionFile. Generated"
    mv $versionFile.tmp $versionFile
fi

wmake libso swak4FoamParsers

wmake libso groovyBC

wmake libso swakFunctionObjects

unset WE_HAVE_SIMPLE_FUNCTION_OBJECTS

if [ -d simpleFunctionObjects ]; then 
    WE_HAVE_SIMPLE_FUNCTION_OBJECTS=1
    
    wmake libso simpleFunctionObjects
else
    if [ -d "$WM_PROJECT_USER_DIR/Libraries/simpleFunctionObjects/lnInclude" ]; then 
	WE_HAVE_SIMPLE_FUNCTION_OBJECTS=1
    fi
fi

if [ "$WE_HAVE_SIMPLE_FUNCTION_OBJECTS" ]; then
    wmake libso simpleSwakFunctionObjects
else
    echo "\n   simpleSwakFunctionObjects not compiled because no simpleFunctionObjects installation found\n"
fi

unset WE_HAVE_SIMPLE_FUNCTION_OBJECTS

wmake libso swakTopoSources

wmake libso swakSourceFields

if [ "$FOAM_DEV" != "" ]
then
    wmake libso swakFiniteArea
fi

wmake libso groovyStandardBCs

if [ "$SWAK_PYTHON_INCLUDE" != "" ]
then
    wmake libso pythonIntegration
else
    echo "SWAK_PYTHON_INCLUDE not defined .... no Python-Integration"
fi